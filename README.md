# Apartment price and demand forecast
Набор Python-скриптов для оценки квартир в Москве с учётом долгосрочной (до 2 лет) перспективы.
Back-end для Интеллектуальной системы мониторинга и рекомендаций по формированию стоимости квартир в домах, 
построенных в рамках реализации Программы реновации.
(Упрощенный вариант 2.2)

## 1. Комплект поставки.

M_Price_2_2.py - прогнозирование/эксплуатация с запросом API<BR>
start.ipynb - образец формирования и выполнения запроса.<BR>
<B>/src:</B><BR>
reservoir_model.py - процедуры для прогнозирования индекса цен на горизонт до 105 недель. <BR>
GBoost_model.pkl - сохранённые веса моделей (в архиве не все, недостающие появятся после обучения моделей)* <BR>
Сохраненая модель может не запуститься на некоторых процесорах. В таком случае следует обучить и сохранить её на той технике, на которой предстоит использовать. 
Для этого в папке /M_train есть обучающий набор данных /M_train/train_df.csv и процедура обучения с сохранением /M_train/model_train.ipynb
Полученный GBoost_model.pkl следует поместить в /src.
<BR>
<B>/results</B> - папка для сохранения результатов<BR>
<B>Справочники /data</B><BR>
	data_run.xlsx – сырые данные о сделках для прогноза (фрагмент исходных данных по сделкам 1686 шт.) <BR>
	dom_index.csv – индекс московской недвижимости Домклик** для коррекции результата (обновляется автоматически раз в неделю)<BR>
	edu.csv – координаты образовательных учреждений<BR>
	enterprises.csv – координаты промышленных объектов<BR>
	med.csv – координаты медицинских учреждений<BR>
	metro.csv – координаты станций метрополитена<BR>
	price_ind.csv – индекс цен по Росстату для подготовки обучающих данных<BR>
	railway.csv – координаты железнодорожных станций<BR>
 	cem.csv – координаты кладбищ<BR>
 <BR>
 Для расчёта спроса на разные типы квартир:<BR>
 	d_amr.csv - исторически данные с полями: Дата регистрации, Площадь квартиры, Район<BR>
  	distr_coord - географические координаты (десятичные) центроидов районов Москвы
  ______________
*) Обновлена по сравнению с прежней версией от M_Price.py, с прежней не совместима.<BR>
**) https://www.moex.com/ru/index/MREDC/archive?from=2025-01-26&till=2025-02-26&sort=TRADEDATE&order=desc


## 2. Импорты - зависимости.
	Python.3.10
		time
		pickle
		warnings
		json
	pandas 2.2.3
	numpy >1.19.5
	sklearn 1.5.2
 	flask 3.1.0

Кроме того используются:<BR>
reservoir_model - самодельный модуль резервуарной нейронной сети для прогнозирования индекса цен при учёте инфляции в долгосрочном прогнозе.<BR>
pymssa - библиотека многомерного сингулярного спектрального анализа для прогноза доли квартир различных типов в общем количестве продаваемых квартир. Заимствована у <A href='https://github.com/kieferk/pymssa'>kieferk</A>, там чистый Python, достаточно скопировать папку /pymssa в /src.

## 3. Входные данные.
Входные данные для прогноза стоимости передаются в запросе следующим образом:
https://127.0.0.1:5000/price?horizon=2&planchers_tot=56&height=179.9&souterrain=2&planchers_sur=54&n_app=450&superficie_tot=38910&espace_de_vie=22301.0&lon=37.398552745&lat=55.830326602
где<BR>
	
 	{
  	'horizon':2, # горизонт прогноза
	'planchers_tot':56, # общее количество этажей
	'height':179.9, # высота обхекта (м)
	'souterrain':2, # количество подземных этажей
	'planchers_sur':54, # количество надземных этажей
	'n_app':450, # количество квартир
	'superficie_tot':38910, # общая площадь объекта 
	'espace_de_vie':22301.0, # жилая площадь объекта
	'lon':37.398552745, # долгота 
	'lat':55.830326602 # широта
 	}

Для определения предпочтений по типам: 
http://127.0.0.1:5000/demand?lon=37.65596415&lat=55.625664549999996&year=2026&month=7
где<BR>

	{
	'lon':lat, # долгота 
	'lat':lon, # широта 
	'year':2026, # прогнозируемый год
	'month':7, # прогнозируемый месяц
	}

## 4. Запрос API.

Пример кода для формирования запроса про цену кв. метра:<BR>

	from urllib.parse import urlencode
	param={
    	'horizon':2, # горизонт прогноза
    	'planchers_tot':56, # общее количество этажей
    	'height':179.9, # высота обхекта (м)
    	'souterrain':2, # количество подземных этажей
    	'planchers_sur':54, # количество надземных этажей
    	'n_app':450, # количество квартир
    	'superficie_tot':38910, # общая площадь объекта 
   	'espace_de_vie':22301.0, # жилая площадь объекта
    	'lon':37.398552745, # долгота
    	'lat':55.830326602 # широта
	}
	url = 'https://127.0.0.1:5000/price?'+urlencode(param)<BR>

'https://127.0.0.1:5000/price?horizon=2&planchers_tot=56&height=179.9&souterrain=2&planchers_sur=54&n_app=450&superficie_tot=38910&espace_de_vie=22301.0&lon=37.398552745&lat=55.830326602' <BR>

Пример кода для формирования запроса про приоритеты: <BR>

	lon, lat =55.750886550000004,37.592144149999996
	param={
    		'lon':lat, # долгота 
   		 'lat':lon, # широта 
    		'year':2026, # прогнозируемый год
   		 'month':7, # прогнозируемый месяц
	}
	url= 'http://127.0.0.1:5000/demand?'+urlencode(param)
http://127.0.0.1:5000/demand?lon=37.592144149999996&lat=55.750886550000004&year=2026&month=7 <BR>

Образец выполнения в прилагаемом файле <A href='https://github.com/Anthony-Cov/Mos_real_estate/blob/main/start.ipynb'>start.ipynb</A>. <BR>

## 5. Ответ API.
<B>Для прогноза цены:</B><BR>

	{
  	"file_name": "results/prognose_2025-05-30_13-00-29.xlsx", # имя Excel-файла с результатом<BR>
  	"forecast_horizon": 2.0, # горизонт прогноза (при некорректном вводе заменяется на 0.0, c комментарием в 'response'<BR>
  	"lat": 55.830326602, # широта<BR>
  	"lon": 37.398552745, # долгота<BR>
  	"price_index": 1.139, # прогноз индекса цен на заданный горизонт (при подозрении на неадекватность комментарий в 'response'<BR>
  	"pricemetr": 440.34, # рассчитанная цена кв. метра в тысячах рублей<BR>
  	"response": "Okay" # комментарий о данных и прогнозах ('Okay' - всё хорошо)<BR>
   	"code": 0 # код завершения<BR>
	}
Код завершения: 
<UL>
	<LI>0 - всё в порядке</LI>
 	<LI>-1 - Неверно задан горизонт прогноза. Значение должно быть одно из [0., 0.25, 0.5, 0.75, 1.0, 1.25, 1.5,1.75, 2.0]. В остальных случаях заменяется нулём.</LI>
 	<LI>-2 - Сомнение в соответстви данных о количестве этажей и высоте здания</LI>
 	<LI>-3 - Нет данных для прогнозирования индекса. Индекс принимается равным единице</LI>
 	<LI>-4 - Прогноз индекса сомнителен (больше 3 или меньше 1), но результат всё равно выдан и учетом этого индекса </LI>
</UL>	
<BR>
Результат сохраняется в Excel-файл с именем, идентифицируемым по дате и времени в папке results/ .<BR>

<B>Для прогноза приоритетов:</B>

	 {'1': 0.47, # Доля однокомнатных
	 '2': 0.25,  # Доля двухкомнатных
	 '3': 0.2,  # Доля трёхкомнатных
	 '4': 0.09, # Доля четырёхкомнатных
	 'code': 0,
	 'date': '2026-07-01',
	 'district': 'Марьина Роща',
	 'response': 'Okay'}

Код завершения: 
<UL>
	<LI>0 - всё в порядке</LIL>
 	<LI>-1 - мало данных по району.</LI>
 	<LI>-2 - неизвестный район (в практике не встречается)</LI>
</UL>
  
